---
id: "tunnels"
title: "Механизм туннелирования"
slug: "/guides/tunnel-clients/minecraft/tunnels"
sidebar_position: 3
---

# Механизм туннелирования

Для предоставления внешнего доступа к сервисам, используется механизм туннелирования. В этом процессе задействованы два 
компонента: туннель-сервер и туннель-клиент.

Туннель-сервер располагается на узле с открытым IP адресом. Его задача заключается в регистрации соединений от 
туннель-клиентов по IP адресу и перенаправлении входящих внешних соединений к зарегистрированным туннель-клиентам, 
которые не имеют открытых IP адресов, и в последующем возврате ответов от этих клиентов.

Один туннель-сервер способен обслуживать одновременно несколько доменов и соответствующих им туннель-клиентов. 
При подключении множества туннель-клиентов к одному и тому же домену, сервер использует механизм round robin для 
равномерного распределения запросов между клиентами.

Для выделения IP адреса от туннель-сервера, необходимо создать заказ. В данных заказа в корне передается файл 
`./auth-token`, содержащий внутри текстовый токен. Этот токен впоследствии будет использоваться туннельным клиентом для 
аутентификации.

В ответ на заказ, в результате заказа, туннель-сервер возвращает JSON строку следующего формата: 
`{"ip":"123.123.123.123","port":443}`. Это означает, что туннель-сервер успешно присвоил IP адрес и готов к подключению 
на данном IP и порте для переданного токена.

После получения ответа от туннель-сервера можно подключиться к нему с помощью туннель-клиента.

На вход туннель-клиенту подаются данные, в которых в корне должен быть файл `config.json` в следующем формате:

```json
{
  "tunnels": [
    {
      "sgxMrSigner": "TUNNEL_SERVER_MRSIGNER",
      "sgxMrEnclave": "TUNNEL_SERVER_MRENCLAVE"
    }
  ],
  "authToken": "AUTH_TOKEN",
  "site": {
    "cert": "./website-fullchain.crt",
    "key": "./website-private-key.pem"
  }
}
```

А также должна быть папка content с содержимым.

Туннель-клиент совершает следующие действия:

1. Разворачивает локальный HTTPS-сервер туннелируемого решения. Для этого решение должно предоставлять файл `server.js` 
   в одной из папок входных данных:

    ```bash
    /content, /content/dist, /content/build
    ```
    
    и принимать следующие переменные окружения:

   * HTTPS\_PORT. Порт, на котором нужно развернуть локальный HTTPS-сервер, к которому будет установлено туннелируемое подключение.
   * TLS\_CERT. Сертификат HTTPS-сервера.
   * TLS\_KEY. Приватный ключ HTTPS-сервера.

2. Считывает сертификат домена и токен для подключения к серверу из файла конфигурации `config.json`.
3. Присоединяется к туннель-серверу и передает ему токен и сертификат домена с приватным ключом для регистрации и 
обработки входных подключений.
4. После успешной регистрации туннель-клиент пробрасывает трафик к развернутому локальному серверу от туннель-сервера и 
возвращает обратно ответы.

### GitHub Actions

Чтобы автоматизировать процесс запуска туннель-сервера и туннель-клиента и процесс деплоя в TEE, используется GitHub Actions.

В директории `.github/workflows` находятся два скрипта, которые запускают туннель-сервер и туннель-клиент.
